#!/bin/bash
#
# Start diaspora websocket and main services
#
# See issue 287

# Is someone listening on 3000 already? (ipv4 only test ?)
services=$( netstat -nl | grep '[^:]:3000[ \t]')
test -n "$services" && {
    echo "Warning: something is already using port 3000"
    echo "     $services"
}


# Check if Mongo is running

if ! ps ax | grep -v grep | grep mongod >/dev/null
then
    echo "Mongod not started"
else
    mkdir -p -v log/thin/
    #force AGPL
    test -w public -a ! -e  public/source.tar &&
        tar cf public/source.tar  --exclude='source.tar' -X .gitignore *
    test -e public/source.tar || {
        echo "Can't find, or even create, public/source.tar. Giving up"
        exit 2
    }
    bundle exec ruby ./script/websocket_server.rb&
    bundle exec thin start $@
fi

